<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Browse Machines | AgriLease</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="../assets/css/theme.css"/>
    <link rel="stylesheet" href="../assets/css/main.css"/>
    <link rel="stylesheet" href="../assets/css/forms.css"/>
    <style>
        .machines-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem; }
        .sidebar-filter { width: 280px; flex-shrink: 0; }
        .filter-section { background: white; border-radius: var(--radius-xl); border: 1px solid #eef2f6; padding: 1.8rem; margin-bottom: 1.5rem; }
        .filter-section h4 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 1.2rem; font-weight: 700; }
        .price-range { display: flex; gap: 12px; align-items: center; }
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-lg); }
        @keyframes shimmer { to { background-position: -200% 0; } }
        .skeleton-card { height: 360px; }
        @media (max-width: 900px) { .sidebar-filter { display: none; } }
    </style>
</head>
<body>
    <div id="navbar-placeholder"></div>

    <div class="page-header">
        <div>
            <h1>Browse Machines</h1>
            <p>Find the right agricultural equipment near you</p>
        </div>
        <div style="display:flex; gap:1rem; align-items:center;">
            <div class="search-bar" style="width: 280px;">
                <span class="material-symbols-outlined">search</span>
                <input type="text" id="search-input" placeholder="Search machines...">
            </div>
            <a href="map.html" class="btn btn-outline btn-sm">
                <span class="material-symbols-outlined" style="font-size:1rem;">map</span>
                Map View
            </a>
        </div>
    </div>

    <div style="padding: 2.5rem 5%; display: flex; gap: 2.5rem; align-items: flex-start;">

        <!-- SIDEBAR FILTERS -->
        <aside class="sidebar-filter">
            <div class="filter-section">
                <h4>Availability</h4>
                <div class="filter-bar" style="flex-direction: column; align-items: flex-start;">
                    <label class="form-check">
                        <input type="radio" name="availability" value="all" checked class="filter-radio"> 
                        <span class="form-check-label">All Machines</span>
                    </label>
                    <label class="form-check">
                        <input type="radio" name="availability" value="available" class="filter-radio">
                        <span class="form-check-label">Available Now</span>
                    </label>
                </div>
            </div>

            <div class="filter-section">
                <h4>Category</h4>
                <div style="display: flex; flex-direction: column; gap: 8px;" id="category-filters">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="filter-section">
                <h4>District</h4>
                <select class="form-control" id="district-filter">
                    <option value="">All Districts</option>
                </select>
            </div>

            <div class="filter-section">
                <h4>Price Range (LKR / day)</h4>
                <div style="margin-bottom: 8px;">
                    <input type="range" class="form-range" id="price-range" min="0" max="50000" step="1000" value="50000">
                </div>
                <div class="range-labels">
                    <span>LKR 0</span>
                    <span id="price-range-label" style="font-weight:700; color:var(--primary);">LKR 50,000</span>
                </div>
            </div>

            <div class="filter-section">
                <h4>Options</h4>
                <label class="form-check">
                    <input type="checkbox" id="filter-operator">
                    <span class="form-check-label">With Operator Available</span>
                </label>
            </div>

            <button class="btn btn-outline" style="width: 100%; justify-content: center;" id="clear-filters">
                <span class="material-symbols-outlined" style="font-size:1rem;">filter_list_off</span>
                Clear Filters
            </button>
        </aside>

        <!-- MAIN CONTENT -->
        <div style="flex: 1; min-width: 0;">

            <!-- Sort + result count -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                <p id="results-count" style="color: var(--text-muted); font-weight: 600; font-size: 0.95rem;">Loading machines...</p>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="font-size: 0.85rem; color: var(--text-muted); font-weight: 600;">Sort:</span>
                    <select class="form-control" id="sort-select" style="width: auto; font-size: 0.875rem; padding: 0.5rem 2.5rem 0.5rem 0.75rem;">
                        <option value="default">Recommended</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="rating">Top Rated</option>
                    </select>
                </div>
            </div>

            <!-- Machines Grid -->
            <div class="machines-grid" id="machines-grid">
                <!-- Skeleton loaders -->
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            </div>

            <!-- Pagination -->
            <div style="display: flex; justify-content: center; gap: 8px; margin-top: 3rem;" id="pagination"></div>
        </div>
    </div>

    <div id="footer-placeholder"></div>
    <div class="toast-container" id="toast-container"></div>

    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Populate category filters
        const categories = ['Tractor', 'Harvester', 'Agricultural Drone', 'Sprayer', 'Plough'];
        const catContainer = document.getElementById('category-filters');
        catContainer.innerHTML = `
            <label class="form-check">
                <input type="checkbox" class="cat-filter" value="all" checked>
                <span class="form-check-label">All Categories</span>
            </label>
            ${categories.map(c => `
            <label class="form-check">
                <input type="checkbox" class="cat-filter" value="${c}">
                <span class="form-check-label">${c}</span>
            </label>`).join('')}
        `;

        // Populate districts
        const districts = ['Colombo','Kandy','Galle','Kurunegala','Polonnaruwa','Anuradhapura','Ampara','Jaffna','Trincomalee','Gampaha'];
        const distSelect = document.getElementById('district-filter');
        districts.forEach(d => {
            distSelect.innerHTML += `<option value="${d}">${d}</option>`;
        });

        // Load machines
        let allMachines = [];
        try {
            const res = await AgriLease.API.getMachines();
            allMachines = res.data;
        } catch (e) {
            console.error(e);
        }

        function getFilters() {
            const availability = document.querySelector('input[name="availability"]:checked')?.value;
            const price = parseInt(document.getElementById('price-range').value);
            const district = document.getElementById('district-filter').value;
            const query = document.getElementById('search-input').value.toLowerCase();
            const operator = document.getElementById('filter-operator').checked;
            const sort = document.getElementById('sort-select').value;
            return { availability, price, district, query, operator, sort };
        }

        function applyFilters() {
            const f = getFilters();
            let data = [...allMachines];

            if (f.availability === 'available') data = data.filter(m => m.available);
            if (f.price < 50000) data = data.filter(m => m.price <= f.price);
            if (f.district) data = data.filter(m => m.district === f.district);
            if (f.query) data = data.filter(m => m.name.toLowerCase().includes(f.query) || m.category.toLowerCase().includes(f.query));
            if (f.operator) data = data.filter(m => m.operator);

            if (f.sort === 'price-asc') data.sort((a,b) => a.price - b.price);
            else if (f.sort === 'price-desc') data.sort((a,b) => b.price - a.price);
            else if (f.sort === 'rating') data.sort((a,b) => b.rating - a.rating);

            renderGrid(data);
        }

        function renderGrid(machines) {
            const grid = document.getElementById('machines-grid');
            document.getElementById('results-count').textContent = `${machines.length} machine${machines.length !== 1 ? 's' : ''} found`;

            if (machines.length === 0) {
                grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <span class="material-symbols-outlined">search_off</span>
                    <h3>No machines found</h3>
                    <p>Try adjusting your filters or search terms.</p>
                    <button class="btn btn-primary" id="reset-btn">
                        <span class="material-symbols-outlined" style="font-size:1rem;">refresh</span> Reset Filters
                    </button>
                </div>`;
                document.getElementById('reset-btn')?.addEventListener('click', resetFilters);
                return;
            }
            grid.innerHTML = machines.map(m => AgriLease.App.renderMachineCard(m)).join('');
        }

        function resetFilters() {
            document.querySelector('input[name="availability"][value="all"]').checked = true;
            document.getElementById('price-range').value = 50000;
            document.getElementById('price-range-label').textContent = 'LKR 50,000';
            document.getElementById('district-filter').value = '';
            document.getElementById('search-input').value = '';
            document.getElementById('filter-operator').checked = false;
            document.getElementById('sort-select').value = 'default';
            applyFilters();
        }

        // Price range label
        document.getElementById('price-range').addEventListener('input', function() {
            document.getElementById('price-range-label').textContent = `LKR ${parseInt(this.value).toLocaleString()}`;
            applyFilters();
        });

        // Event listeners
        document.querySelectorAll('.filter-radio, .cat-filter').forEach(el => el.addEventListener('change', applyFilters));
        document.getElementById('district-filter').addEventListener('change', applyFilters);
        document.getElementById('search-input').addEventListener('input', AgriLease.debounce(applyFilters, 250));
        document.getElementById('filter-operator').addEventListener('change', applyFilters);
        document.getElementById('sort-select').addEventListener('change', applyFilters);
        document.getElementById('clear-filters').addEventListener('click', resetFilters);

        // Initial render
        renderGrid(allMachines);
    });
    </script>
</body>
</html>
